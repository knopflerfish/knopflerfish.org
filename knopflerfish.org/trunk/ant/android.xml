<?xml version="1.0" encoding="UTF-8"?>
<!--
   ** Copyright (c) 2011-2013, KNOPFLERFISH project
   ** All rights reserved.
   **
   ** Redistribution and use in source and binary forms, with or without
   ** modification, are permitted provided that the following conditions
   ** are met:
   **
   ** - Redistributions of source code must retain the above copyright notice,
   **   this list of conditions and the following disclaimer.
   **
   ** - Redistributions in binary form must reproduce the above copyright
   **   notice, this list of conditions and the following disclaimer in
   **   the documentation and/or other materials provided with the
   **   distribution.
   **
   ** - Neither the name of the KNOPFLERFISH project nor the names of its
   **   contributors may be used to endorse or promote products derived
   **   from this software without specific prior written permission.
   **
   ** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
   ** "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
   ** LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
   ** FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
   ** COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
   ** INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   ** (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
   ** SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
   ** HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
   ** STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   ** ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
   ** OF THE POSSIBILITY OF SUCH DAMAGE.
  -->
<!-- ============================================================ -->
<!--  Android instrumentation support,                            -->
<!--  adds a .dex-file to a bundle jar-file                       -->
<!-- ============================================================ -->
<project name="android_instrumentation" basedir=".">

  <!-- Are we building for Dalvik/Android? -->
  <available property="android.exists" file="${ANDROID_HOME}"/>

  <!-- look for dx.jar and aapt in Android sdk -->
  <first id="first.dx">
    <fileset dir="${ANDROID_HOME}"
             includes="**/dx.jar"
             erroronmissingdir="false"/>
  </first>
  <first id="first.aapt">
    <fileset dir="${ANDROID_HOME}"
             includes="**/aapt*"
             erroronmissingdir="false"/>
  </first>
  <property name="android.tool.dx" value="${toString:first.dx}" />
  <property name="android.tool.aapt" value="${toString:first.aapt}" />


  <macrodef name="add_dex"
            description="Generates xargs-file from templare.">
    <attribute name="jarfile"
               description="The jar file to create and add a .dex-file to."/>
    <attribute name="outdir"
               description="Directory to write temporary file to"/>

    <sequential>
      <basename file="@{jarfile}" suffix="jar" property="jarfile.basename"/>
      <tempfile destdir="@{outdir}" prefix="${jarfile.basename}"
                property="temp.dir"/>
      <mkdir dir="${temp.dir}"/>
      <property name="temp.dex" location="${temp.dir}/classes.dex"/>

      <exec executable="${android.tool.aapt}" dir="${temp.dir}">
        <arg value="remove"/>     
        <arg value="-f"/>
        <arg value="@{jarfile}"/>
        <arg value="classes.dex"/>
      </exec>

      <java fork="true" jar="${android.tool.dx}">
        <arg value="--dex"/>
        <arg value="--output=${temp.dex}"/>
        <arg value="@{jarfile}"/>
      </java>

      <exec executable="${android.tool.aapt}" dir="${temp.dir}">
        <arg value="add"/>     
        <arg value="-f"/>
        <arg value="@{jarfile}"/>
        <arg value="classes.dex"/>
      </exec>

      <delete dir="${temp.dir}"/>
    </sequential>
  </macrodef>

  <!-- Helper taget that adds Android dex data to the bundle. -->
  <target name="add_dex" if="android.exists">
  </target>

</project>
