<?xml version="1.0" encoding="UTF-8"?>

<project name="restart_test" default="all">

  <dirname property="proj.dir" file="${ant.file.restart_test}"/>
  <import  file="${proj.dir}/../test_import.xml"/>

  <property name = "bundle.build.all"  value="false"/>
  <property name = "bundle.build.api"  value="false"/>
  <property name = "bundle.build.lib"  value="false"/>
  <property name = "bundle.build.impl" value="true"/>
  <property name = "bundle.build.doc"  value="false"/>

  <property name  = "impl.pattern"
            value = "org/knopflerfish/bundle/**"/>

  <path id = "bundle.compile.path">
    <pathelement location="junit_all-N.N.N.jar"/>
    <pathelement location="${osgi.dir}/bundles_opt/junit/junit/resources/junit.jar"/>
  </path>

  <property name="resources.dir" location="${proj.dir}/resources"/>
  <property name="ttb.outdir" location="${topdir}/out/${ant.project.name}/ttb"/>

  <property name="do.bundle.custom.pre" value="true"/>
  <target name="bundle.custom.pre">
    <antcall target="bundleA_test"/>
    <antcall target="bundleB_test"/>
    <antcall target="bundleC_test"/>
    <antcall target="bundleF_test"/>
  </target>

  <target name="bundleA_test">
    <ant dir="test_target_bundles/bundleA_test" target="all"
	 inheritAll="false">
      <property name="jardir"  location="${resources.dir}"/>
      <property name="outdir"  location="${ttb.outdir}/bundleA_test"/>
    </ant>
  </target>
  <target name="bundleB_test">
    <ant dir="test_target_bundles/bundleB_test" target="all"
	 inheritAll="false">
      <property name="jardir"  location="${resources.dir}"/>
      <property name="outdir"  location="${ttb.outdir}/bundleB_test"/>
    </ant>
  </target>
  <target name="bundleC_test">
    <ant dir="test_target_bundles/bundleC_test" target="all"
	 inheritAll="false">
      <property name="jardir"  location="${resources.dir}"/>
      <property name="outdir"  location="${ttb.outdir}/bundleC_test"/>
    </ant>
  </target>
  <target name="bundleF_test">
    <ant dir="test_target_bundles/bundleF_test" target="all"
	 inheritAll="false">
      <property name="jardir"  location="${resources.dir}"/>
      <property name="outdir"  location="${ttb.outdir}/bundleF_test"/>
    </ant>
  </target>


  <property name="do.bundle.custom.post" value="true"/>
  <property name="xargs1" location="test-restart1.xargs"/>
  <property name="xargs2" location="test-restart2.xargs"/>
  <target name="bundle.custom.post">
    <property name="bundleVersionFilterTester"
	      location="${outdir}/${ant.project.name}.props"/>
    <bundle_locator replacefilterfile="${bundleVersionFilterTester}">
      <fileset dir="${jars.dir}">
	<include name="**/*.jar"/>
      </fileset>
      <fileset dir="${osgi.dir}/jars">
	<include name="**/*.jar"/>
      </fileset>
    </bundle_locator>
    <copy file="${xargs1}.in" tofile="${xargs1}" overwrite="true"/>
    <replace file="${xargs1}"
	     replacefilterfile="${bundleVersionFilterTester}">
      <replacefilter token="$(OSGI_DIR)" value="${osgi.dir}"/>
      <replacefilter token="$(JAR_PREFIX)"
		     value="file:${jars.dir}/;file:${osgi.dir}/jars/"/>
    </replace>
    <copy file="${xargs2}.in" tofile="${xargs2}" overwrite="true"/>
    <replace file="${xargs2}"
	     replacefilterfile="${bundleVersionFilterTester}">
      <replacefilter token="$(OSGI_DIR)" value="${osgi.dir}"/>
      <replacefilter token="$(JAR_PREFIX)"
		     value="file:${jars.dir}/;file:${osgi.dir}/jars/"/>
    </replace>
  </target>

  <import file="${ant.dir}/bundlebuild.xml"/>

</project>
