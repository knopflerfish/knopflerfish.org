<?xml version="1.0" encoding="UTF-8"?>

<project name="test_import" default="all">

  <!-- Common definitions for all test bundles. -->
  <dirname  property="topdir" file="${ant.file.test_import}"/>
  <property name="osgi.dir"   location="${topdir}/../.."/>
  <property name="ant.dir"    location="${osgi.dir}/../ant"/>
  <property name="jars.dir"   location="${osgi.dir}/test_jars"/> 
  <property name="condperm_warnings.file" location="${osgi.dir}/WARNING-condpermadmin.txt"/>

  <!-- Base URLs for test-case xargs files. Must not use ${jars.dir},
       ${osgi.dir} here since that would result in absolute paths in
       the base URL which is not good when the xargs file is used in
       the distribution. -->
  <property name="tests.base.urls"
	    value="file:test_jars/;file:jars/"/>

  <!-- Filters "${xargs}.in" -> "${xargs}" -->
  <target name="test-xargs">
    <fail unless="xargs.file" message="xargs.file must be set."/>
    <fail unless="bundleVersionFilterTester"
	  message="bundleVersionFilterTester must be set."/>

    <bundle_locator replacefilterfile="${bundleVersionFilterTester}">
      <fileset dir="${jars.dir}">
	<include name="**/*.jar"/>
      </fileset>
      <fileset dir="${osgi.dir}/jars">
	<include name="**/*.jar"/>
      </fileset>
    </bundle_locator>
    <copy file="${xargs.file}.in" tofile="${xargs.file}" overwrite="true"/>
    <replace file="${xargs.file}"
	     replacefilterfile="${bundleVersionFilterTester}">
      <replacefilter token="$(OSGI_DIR)" value="${osgi.dir}"/>
      <replacefilter token="$(JAR_PREFIX)" value="${tests.base.urls}"/>
    </replace>	  
  </target>

  <!--
    || Checks and warns if the openssl program is not installed
    || Used to skip building the condpermadmin tests int that case
    -->
  <target name="check_warn_openssl"
	  depends="clear_openssl_warning, check_openssl"
	  unless="openssl_exist">
    <echo message="Warning, no openssl program found. CPA can not be tested"/>
    <echo file="${condperm_warnings.file}">WARNING
Can not find an openssl program

The openssl program is needed to run the condpermadmin tests. This test will therefore fail.

Please install the openssl program to enable condpermadmin testing.
    </echo>
  </target>      

  <target name="clear_openssl_warning">
    <delete file="${condperm_warnings.file}"  quiet="true" />
  </target>

  <target name="check_openssl">
    <exec executable="openssl" 
	  failifexecutionfails="false"
	  resultproperty="openssl_return_code">
      <arg value="version" />
    </exec>
    <condition property="openssl_exist">
      <isset property="openssl_return_code"/>
    </condition>
  </target>
  
</project>
 
