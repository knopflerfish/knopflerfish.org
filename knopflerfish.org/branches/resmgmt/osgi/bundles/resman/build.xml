<?xml version="1.0" encoding="UTF-8"?>

<project name="resman" default="all">

  <dirname  property="proj.dir" file="${ant.file.resman}"/>
  <property name="topdir"       location="${proj.dir}/../.."/>

  <property name = "ee.check.foundation"   value = "true"/>

  <property name = "bundle.build.api"   value = "false"/>
  <property name = "bundle.build.impl"  value = "false"/>
  <property name = "bundle.build.all"   value = "true"/>
  <property name = "bundle.build.lib"   value = "false"/>

  <!-- No bundle activator in an extension bundle. -->
  <property name="bundleinfo.failOnActivator" value="false"/>
  <property name="attrs.to.skip.all"          value="Bundle-Activator,Import-Package"/>

  <property name="api.pattern"  value="org/knopflerfish/service/resman/**"/>
  <property name="impl.pattern" value="org/knopflerfish/bundle/resman/**"/>

  <property name="mikaResourceMonitor.jar"
	    location="lib/mikaResourceMonitor.jar"/>

  <path id="bundle.compile.path">
    <pathelement location="log_api-N.N.N.jar"/>
    <pathelement location="${mikaResourceMonitor.jar}"/>
  </path>

  <import file="${topdir}/../ant/bundlebuild.xml"/>

  <!-- Extract the classes need to compile from Mika Max runtime -->
  <property name="wre.jar" location="wre.jar"/>
  <available property="wre.jar.exists" file="${wre.jar}"/>

  <target name="extract"
	  description="Extracts the ResourceMonitor class from the wre.jar into lib/mikaResourceMonitor.jar">

    <fail unless="wre.jar.exists">
      The runtime library of Mika Max,
      ${wre.jar}
      must exist to be able to extract contents from it.
    </fail>

    <!-- Extract Mika manifest from wre.jar -->
    <unjar src="${wre.jar}" dest="${outdir}">
      <patternset>
        <include name="META-INF/MANIFEST.MF"/>
      </patternset>
      <mapper type="glob" from="META-INF/MANIFEST.MF" to="wre.mf"/>
    </unjar>

    <mkdir dir="lib"/>
    <jar destfile="${mikaResourceMonitor.jar}"
	 filesetmanifest="merge"
         compress="true"
	 filesonly="true"
	 duplicate="fail">
      <manifest>
	<attribute name="Knopflerfish-Description"
		   value="Mika Max Resource Management classes form wre.jar"/>
      </manifest>
      <zipfileset src="${wre.jar}" prefix="">
        <include name="mika/max/ResourceMonitor.class"/>
        <include name="META-INF/MANIFEST.MF"/>
      </zipfileset>
    </jar>
  </target>

</project>
