<h1>Directory Deployer</h1>

<p>
A bundle which scans file system directories for files that it can
install, update or uninstall. The directory deployer bundle handles
both bundle files and configuration files.  When a file is updated the
bundle / configuration will be updated and when a file is removed from
the scaned directory the bundle / configuration will be removed.
</p>

<p>
This is a quite useful tool for handle bundle and configuration
deployment without using any console. Just copy the file that should
be installed to the deploy directory, and the directory deployer will
find and activate them. When the files are removed, they are
uninstalled.
</p>


<h2>Deploy method</h2>

<p>The procedure for scanning and deploying is as follows:

<ol>
  <li>
      Check if any new files have appeared or if any already deployed
      files has been replaced with newer files.
  </li>

  <li>
      New files are installed into the framework.<br> At the end of
      the scan any bundle that was installed will be started according
      to its activation policy. Any fragment that was installed will
      be attached to its host (be resolving it).
  </li>

  <li>
      Updated files (newer than a previously deployed bundle) are not
      installed again, instead, the installed bundle or configuration
      is updated from the new file.
  </li>

  <li>
      Check if there are bundles or configurations installed by the
      directory deployer that does not correspond to a file found
      during the directory scan. If any such bundle or configuration
      is found uninstall it.
  </li>

  <li>
      If any bundle update was performed during the scan, perform a
      refresh bundles operation for them using the in the framework
      wiring API.
  </li>

  <li>
      Start newly installed bundles that can be started, resolve newly
      installed fragments. Note that there will only be one start /
      resolve attempt made for each bundle after an install or update.
  </li>

  <li>
      Sleep a while
  </li>

  <li>
      Repeat from 1.
  </li>

</ol>

<h2>Deployable File Types</h2>

The Directory Deployer supports two types of files:

<ul>

  <li>Bundle jar files. File name must end with <tt>.jar</tt>.

  <li>Configurations in the form of XML-files following the <a
      href="../cm/cm_data.dtd">cm_data.dtd</a>.  File name must end
      with <tt>.xml</tt>.

<ul>
      
  The most convenient way to create an XML-file for a configuration is
  to use the console command <tt>configuration export <em>file</em>
  <em>cfg</em></tt> to export an exisitng configuration. Edit the file
  to change the configuration values. To create a configuration from
  scratch one may use the CM-tab in Knopflerfish desktop, it presents
  a simple GUI based on configuration meta type descriptions provided
  by configurable bundles. The CM-tab is not visible in the Desktop
  when starting the default set of bundles, to activate it one must
  install and start three more bundles: <tt>cm_desktop</tt>,
  <tt>metatype_api</tt> and <tt>kf_metatype_all</tt>.



<h2>Configuration</h2>

<p>
See <a href="$(SVN_REPO_URL)/$(SVN_TAG)/osgi/bundles_opt/dirdeployer/resources/OSGI-INF/metatype/metatype.xml">metatype.xml</a>
for specification using CM. The same properties as defined by CM are
also read as default values from framework properties. Thus, the
bundle can be both configured by CM and using system properties.
</p>

<p>You can set the deployment directory in <tt>metatype.xml</tt> in
the bundle's resource directory (defaults to <tt>./load</tt>). A
relative deployment directory path is relative to the directory from
which the framework is started.</p>

The table below describes the framework properties that may be used to
set the default values for the directory deployer configuration.

<table class="man">
  <tr>
    <th>Name</th>
    <th>Description</th>
    <th>Type</th>
    <th>Default</th>
  </tr>

  <tr>
    <td>org.knopflerfish.fileinstall.dir</td>
    <td>

	Set the directories that should be scanned.

	<p>The value should be a comma-separated list of directory
	paths.</p>

    </td>
    <td>String</td>
    <td>./load</td>
  </tr>

  <tr>
    <td>org.knopflerfish.fileinstall.poll</td>
    <td>

	Poll interval in milliseconds between directory scans. Must be
	at least 100 ms. 

    </td>
    <td>long</td>
    <td>1000</td>
  </tr>

  <tr>
    <td>org.knopflerfish.fileinstall.use.initial.startlevel</td>
    <td>

	Do not assign any start level to bundles installed by the
	Directory Deployer. This means that they will use the initial
	start level set using the FrameworkStartLevel-API.

    </td>
    <td>boolean</td>
    <td>true</td>
  </tr>

  <tr>
    <td>org.knopflerfish.fileinstall.startlevel</td>
    <td>

	Bundle start level to assign to all newly installed
	bundles. Note that you must set
	<tt>org.knopflerfish.fileinstall.startlevel</tt> to false for
	this property to have an effect.

    </td>
    <td>int</td>
    <td>The initial bundle startlevel as returned by the StartLeve-service.</td>
  </tr>

  <tr>
    <td>org.knopflerfish.fileinstall.uninstallOnStop</td>
    <td>

	If <code>true</code> then the directory deployer will
        uninstall all bundles that it has installed when it stops.

    </td>
    <td>boolean</td>
    <td>true</td>
  </tr>
</table>
